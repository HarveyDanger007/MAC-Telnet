name: Configure and Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    name: Configure and Build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false

      matrix:
        os: [ubuntu-latest, macos-13, macos-latest]
        c_compiler: [gcc-10, clang]

    steps:
      - uses: actions/checkout@v3
      - uses: ConorMacBride/install-package@v1
        with:
          brew: gettext autoconf automake libtool openssl
          apt: build-essential autopoint automake autoconf libssl-dev libtool gettext
      - name: Install compiler
        id: install_cc
        uses: rlalik/setup-cpp-compiler@master
        with:
          compiler: ${{ matrix.c_compiler }}
      - name: Fix gettext on macOS
        if: runner.os == 'macOS'
        id: gettext
        run: |
          echo "GETTEXT_PATH=$(brew --prefix gettext)" >> $GITHUB_OUTPUT
          echo "LDFLAGS=-L$(brew --prefix gettext)/lib" >> $GITHUB_OUTPUT
          echo "CPPFLAGS=-I$(brew --prefix gettext)/include" >> $GITHUB_OUTPUT
      - name: autogen/configure
        run: ./autogen.sh
        env:
          GETTEXT_PATH: ${{ steps.gettext.outputs.GETTEXT_PATH }}
          LDFLAGS: ${{ steps.gettext.outputs.LDFLAGS }}
          CPPFLAGS: ${{ steps.gettext.outputs.CPPFLAGS }}
      - name: configure
        run: ./configure CC="${{ steps.install_cc.outputs.cc }}" --prefix="${{ github.workspace }}/build"
        env:
          GETTEXT_PATH: ${{ steps.gettext.outputs.GETTEXT_PATH }}
          LDFLAGS: ${{ steps.gettext.outputs.LDFLAGS }}
          CPPFLAGS: ${{ steps.gettext.outputs.CPPFLAGS }}
      - name: make
        run: make all
        env:
          GETTEXT_PATH: ${{ steps.gettext.outputs.GETTEXT_PATH }}
          LDFLAGS: ${{ steps.gettext.outputs.LDFLAGS }}
          CPPFLAGS: ${{ steps.gettext.outputs.CPPFLAGS }}
